## マイクロサービスとは

単一のアプリケーションを小さなサービス群の組み合わせとして構築する手法

黄金律は、「他は何も変更せずに、単独でサービスの変更やデプロイができるか」

#### メリット

1. サービスごとに適した技術を選択可能
2. 障害が起こっても、一部だけの損失で済む（モノリシックの場合、全てに影響が出る。）
3. スケールのしやすさ(一部の機能だけは、小規模で済ますなど)
4. 一部の機能だけリリースすることが可能
5. サービスの接合順序を自由に組み替えられる

#### 課題

- 複雑さ
  - 各サービスは単純だが、システム全体は複雑になる
- 統制の欠如
  - 異なる言語やフレームワークを使用するために、アプリの維持が難しくなる
- ネットワークの輻輳と待機時間
  - サービスの依存関係のチェーンによる待機時間が API の設計によって生じる可能性が大きい
- データ整合性
  - 各サービスで独自のデータ管理をするので、データの整合性を取るのが難しくなる
- 管理
  - 成熟した DevOps カルチャが必要
- バージョン管理
  - 依存しているサービスを中断してはなならない
  - 複数のサービスが特定の時点で更新される場合があるため、下位互換/上位互換性に問題が生じる可能性がある
- チームのスキルセット
  - 高度なシステムなため、スキルや経験が大いに求められる

参考: [マイクロサービス アーキテクチャ スタイル
](https://docs.microsoft.com/ja-jp/azure/architecture/guide/architecture-styles/microservices)

### 他の分解テクニックとの違い

#### 共有ライブラリ

- 基本的に、同じ言語か少なくとも同じプラットフォームで動作する必要がある
- システムの各部を独立して、スケールできない
  - ライブラリをデプロイするには、全体のデプロイが必要

### 設計上の注意

#### 他のマイクロサービスが管理する DB 内のデータが必要になる

データをやり取りする際は、直接 DB にアクセスするのではなくデータをやり取りする API を用意する。
データベース共有は、マイクロサービスにおける NG パターン

```
// 必要なデータがDBをまたぐ場合

NG
ServiceA -> DB2

OK
ServiceA -> ServiceB -> DB2
```

データベース統合は、サービス間のデータ共有をしやすくする一方で、振る舞いの共有に関しては何もしない。
強い凝縮性と疎結合の両方を失うため、マイクロサービスを採用する意味がなくなる。

例えば、DB に対して 3 箇所で同じロジックを持たなければいけない場合、
1 箇所でも修正することになれば、すべて対応しなければならない。

#### マイクロサービスへの移行の仕方

以下を念頭に置く

- 高凝縮性を実現する
- 密結合を避ける
- 内部表現を共有しない
- 不要な情報を無闇に公開しない
- 新規でサービスを作る場合は、モノリシックに作る
- 安定するまで待つ(ドメイン理解が深まる前に分解すると、直すのに時間がかかる

いきなりマイクロサービスとして作り出すのではなく、ある程度成熟しドメイン理解を得た上で、分解していくのが吉。

また、サービスを分解する際は、大雑把にドメイン分割をしてその中に含まれる境界に沿って分離していくと、上手くいきやすい。

#### サービス間のデータのやり取り

サービス間でどのようにやり取りをするか、がマイクロサービスの肝になる。

方法は、同期的、非同期的 2 種類あり主要な方法として

- オーケストレーション
- コレオグラフィ

の 2 つがある。

##### オーケストレーション

- あるサービスが各サービスを呼び出す
- ハブになることで、各サービスの追跡が可能
- 一方で、中央機関になりすぎるというデメリット

##### コレオグラフィ

- 各サービスは、トリガーとなるイベントをディスクライブして自動実行する
- サービス間での依存が少ないため、サービス間が分離される
- 各サービスが適切に処理されたか監視するには、追加の作業が必要となる

#### UI の提供方法

##### API 合成

クライアント側から、各要素ごとに API にリクエストを投げ UI 側で合成する手法。

- デメリット

  - デバイスごとのレスポンスの調整ができない
    - 渡さなくてもよいデータまで、渡してしまう
    - 取得したいフィールドを指定する方法もあるが、そのような対話型の形式をサポートが前提となる
  - 別のチームが UI 制作をしている場合、小さな変更でも複数のチームに依頼をしないといけないこともある
  - リクエストを複数呼び出すので、デバイスによっては通信量を非効率に使うことになる

  ##### UI 部品合成

  サービスに部品を提供させ、その部品を集めて UI を生成する方法。
  サービスを変更するのと同じチームが UI 部品も担当でき変更を迅速に公開可能

- 注意点

  - シームレスなエクスペリエンスを実現するために、インターフェースの部品ごとに動作や設計を統一させる
  - サービスが提供する機能が、ページに収まらない場合がある。

  ##### BFF (Backend For Frontend)

  ```
  // ❌だめなパターン
  WEB -> API_A -> 各種サービス
  モバイル -> API_A -> 各種サービス

  // API_Aが肥大化し、分離できずに独立してリリースが困難になる。

  // ⭕ 理想系
  WEB -> WEB サイトバックエンド -> 各種サービス
  モバイル -> モバイルバックエンド -> 各種サービス

  // サービスごとに、API ゲートウェイを用意しそこを通して、各種サービスにアクセスする。
  ```
